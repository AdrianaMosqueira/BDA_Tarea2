---
title: "Big Data & Analytics: Trabajo 2"
author: "S. Gutierrez, A. Mosqueira, A. Palacios, E. Quispe, "
date: "05/06/2022"
output:
  rmdformats::material:
  code_folding: show
  self_contained: true
  thumbnails: false
  lightbox: false
pkgdown:
  as_is: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Clear Global environment
rm(list=ls()) 
```

```{r message=FALSE, warning=FALSE}
library(readstata13)
library(survey)
library(tidyverse)
library(foreign)
library(haven)
library(dplyr)
library(rio)
library(tidyr)
library(sampling)
```

# Integrantes:
#### Andrés Palacios
#### Adriana Mosqueira
#### Elías Quispe
#### Sandra Gutierrez

# Parte I

## Pregunta 1.	Descargue el Censo Nacional de Población Penitenciaria 2016 de la página del INEI (http://iinei.inei.gob.pe/microdatos/). Puede descargar solo la carátula o también más módulos de dicho censo.

```{r}
pob_penit= read_sav("01_PENALES_CARATULA.sav", encoding = "UTF-8", user_na = TRUE)
```

## Pregunta 2.	Genere una variable dicotómica con el valor de 1 para quienes cometen “Delitos contra la seguridad pública”, 0 para los demás casos. Llamar a esta variable “pp_dcsp”

```{r}
# Generar la variable de internos que han cometido delitos con la seguridad pública
pob_penit <- pob_penit |> 
  mutate(pp_dcsp = if_else(DELITO_GENERICO=="DELITOS CONTRA LA SEGURIDAD PUBLICA",1,0))
```

## Pregunta 3.	Establecer una semilla (“seed”) usando los dígitos del cumpleaños de alguno de los miembros del grupo.

```{r}
set.seed(19011990) # Clave para poder replicar
```

## Pregunta 4.	Extraer una muestra estratificada y por conglomerados que contenga entre el 1% y 5% de la población (toda la base). Especificar qué variables se utilizan para los estratos y conglomerados y discutir por qué son adecuadas para dicho propósito. Discutir también si hay otras variables que podrían haberse utilizado para los estratos o conglomerados.

Muestra Aleatoria Estratificada

La variable usada para estratificar será el intervalo del número de internos por Establecimiento Penitenciario. Esto permite que cada elemento de un conglomerado pertenezca exclusivamente a un determinado estrato.También se puede utilizar otras variables en este caso sociodemográficas como sexo, edad, nivel educativo, etc.


### Nos interesa saber cuál es la proporción de presos por etapas de vida. Creamos una variable categórica por cohortes que nos serivrá para posterior estratificación.

```{r}
pob_penit=mutate(pob_penit,Grupo_edad=
                       case_when(EDAD %in% c(0:19)~"0-19",
                            EDAD %in% c(20:29)~"20-29",
                            EDAD %in% c(30:39)~"30-39",
                            EDAD %in% c(40:49)~"40-49",
                            EDAD %in% c(50:59)~"50-59",
                            EDAD %in% c(60:69)~"60-69",
                            EDAD %in% c(70:79)~"70-79",
                            EDAD %in% c(80:120)~"80 a mas",
                            TRUE~"Ninguno"))
```

Primero necesitamos una base de los conglomerados
```{r}
base_clusters <- pob_penit %>%
  count(EST_PENIT)
```

Segundo, obtenemos la muestra aleatoria de conglomerados (el número de conflomerados fue elegido de manera a que nuestra muestra contenga entre 1% y 5% del total de la población)
```{r}
set.seed(19011990)
mac1_clusters <- base_clusters %>%
  slice_sample(n = 10)
```

Tercero, juntamos las bases para tener las observaciones de los clusters elegidos
```{r}
mac1_f <- merge(x = pob_penit , y = mac1_clusters , by = c("EST_PENIT"))
```

```{r}
set.seed(19011990)
mac2_f <- mac1_f %>%
  group_by(EST_PENIT) %>%
  slice_sample(n = 100)
```

Verificamos si nuestra muestra contiene entre 1% y 5% del total de la población. 
```{r}
tot_pop=nrow(pob_penit) 
tot_pop 
tot_mue=nrow(mac2_f)
tot_mue

tot_mue/tot_pop
```

Creamos nuestros pesos
Primero verificamos nuestra población N y nuestra muesta n
```{r}
summary(pob_penit$EDAD)
table(pob_penit$Grupo_edad)
table(mac2_f$Grupo_edad)
```

Luego procedemos a crear submuestras para cada uno de los estratos
```{r}
mac2_f_0_19 = subset(mac2_f,mac2_f$Grupo_edad=="0-19")
mac2_f_20_29 = subset(mac2_f,mac2_f$Grupo_edad=="20-29")
mac2_f_30_39 = subset(mac2_f,mac2_f$Grupo_edad=="30-39")
mac2_f_40_49 = subset(mac2_f,mac2_f$Grupo_edad=="40-49")
mac2_f_50_59 = subset(mac2_f,mac2_f$Grupo_edad=="50-59")
mac2_f_60_69 = subset(mac2_f,mac2_f$Grupo_edad=="60-69")
mac2_f_70_79 = subset(mac2_f,mac2_f$Grupo_edad=="70-79")
mac2_f_80_mas = subset(mac2_f,mac2_f$Grupo_edad=="80 a mas")
```

Luego crearemos una variable con la corrección de población finita para cada estrato
Pirmero los creamos como objetos 
```{r}
N019=c(1162)
n019=c(14)
fpc019=1-(n019/N019)
fpc019

N2029=c(24993)
n2029=c(281)
fpc2029=1-(n2029/N2029)
fpc2029

N3039=c(24204)
n3039=c(302)
fpc3039=1-(n3039/N3039)
fpc3039

N4049=c(15308)
n4049=c(226)
fpc4049=1-(n4049/N4049)
fpc4049

N5059=c(7474)
n5059=c(110)
fpc5059=1-(n5059/N5059)
fpc5059

N6069=c(2418)
n6069=c(32)
fpc6069=1-(n6069/N6069)
fpc6069

N7079=c(525)
n7079=c(8)
fpc7079=1-(n7079/N7079)
fpc7079

N80mas=c(58)
n80mas=c(0)
fpc80mas=1-(n80mas/N80mas)
fpc80mas
```

Y luego como variables
```{r}
mac2_f_0_19$fpc_mae=fpc019
head(mac2_f_0_19$fpc_mae)

mac2_f_20_29$fpc_mae=fpc2029
head(mac2_f_20_29$fpc_mae)

mac2_f_30_39$fpc_mae=fpc3039
head(mac2_f_30_39$fpc_mae)

mac2_f_40_49$fpc_mae=fpc4049
head(mac2_f_40_49$fpc_mae)

mac2_f_50_59$fpc_mae=fpc5059
head(mac2_f_50_59$fpc_mae)

mac2_f_60_69$fpc_mae=fpc6069
head(mac2_f_60_69$fpc_mae)

mac2_f_70_79$fpc_mae=fpc7079
head(mac2_f_70_79$fpc_mae)

#No creamos fpc para el grupo de 80 a más porque no hay observaciones
```

Procedemos a fusionar nuestras submuestras.
```{r}
mac2_append1=rbind(mac2_f_0_19, mac2_f_20_29)
mac2_append2=rbind(mac2_append1, mac2_f_30_39)
mac2_append3=rbind(mac2_append2, mac2_f_40_49)
mac2_append4=rbind(mac2_append3, mac2_f_50_59)
mac2_append5=rbind(mac2_append4, mac2_f_60_69)
mac2_append6=rbind(mac2_append5, mac2_f_70_79)
```


## Pregunta 5.	Declarar el diseño muestral (completo) y obtener las siguientes estadísticas (deben ser representativas):

```{r}
diseno_m = svydesign(id = ~EST_PENIT, strata = ~Grupo_edad , fpc = ~fpc_mae , data = mac2_append6, nest = T)
```


### a.	Porcentaje de personas que ha cometido “Delitos contra la seguridad pública”

```{r}
svymean(~pp_dcsp , diseno_m)
```


### b.	Total de personas que ha cometido “Delitos contra la seguridad pública”
```{r}
svytotal(~pp_dcsp , diseno_m)
```


```{r}
# Clear Global environment
rm(list=ls()) 
```

# Parte II: ENARES

A cada grupo se le asignará una encuesta que pueda ser descargada de la página de microdatos del INEI. Dicha encuesta será utilizada para este ejercicio.

## Pregunta 1.	Explicar el diseño muestral de la encuesta. Luego, declarar el diseño muestral (completo). Para esto se recomienda revisar la ficha técnica de la encuesta. Esta se encuentra disponible en la web de microdatos del INEI. 

La Encuesta Nacional de Programas Presupuestales (ENAPRES) tiene como objetivo, detallar información estadística para el seguimiento y evaluación de los Programas Presupuestales (PP) a nivel nacional. Esta encuesta incluye aquellas viviendas particulares y sus ocupantes, quienes residen en el área urbana y área rural del país; sin embargo, se excluyeron aquellas personas que viven en viviendas colectivas. En cuanto al marco muestral básico para la selección de la muestra, se utilizó la información estadística y cartográfica del Sistema de Focalización de Hogares (SISFOH), actualizada al 2012 y 2013 del directorio de viviendas de cada conglomerado seleccionado.

Por su parte, la unidad primaria de muestreo (UPM), diferencia entre el área urbano y rural. Para el primer caso, este se conformó por una o más manzanas consecutivas o adyacentes, además, un conglomerado urbano contiene en promedio 140 viviendas particulares. Para el segundo caso, se identificaron 2 tipos: el conglomerado rural conformado por una o más manzanas consecutivas o adyacentes que tiene 140 viviendas particulares en promedio y el Área de Empadronamiento Rural (AER) que contiene en promedio 100 viviendas particulares.

Además, para ambos casos se considero la vivienda particular comol la unidad secundaria de muestreo (USM). 

En cuanto al tipo de muestreo se identifica que esta encuesta es de tipo probabilística, estratificada, bietápica, independiente en cada departamento, de selección sistemática con probabilidad proporcional al tamaño en la primera etapa y sistemática simple en la segunda etapa. Además, se indica que el nivel de confianza de los resultados es del 95%.

```{r}
setwd("C:/Users/limon/Documents/GitHub/BDA_Tarea2")
```

```{r}
ENAPRES = read_csv("CAP_200_URBANO_RURAL_4.csv")
```

```{r}
table(ENAPRES$ESTRATO)
```

Declarar el diseño muestral
```{r}
ENAPRES_svy = svydesign(id = ~1 , strata = ~ESTRATO, weights = ~FACTOR  , data = ENAPRES)
```

## Pregunta 2.	Elegir y calcular dos variables: (i) una dicotómica = REGIONNATU (Selva ==1, Otros ==0), (ii) una continua = Grupo etario: P208_A. 

(i) Se construye una variable dicotómica, que tendrá el varlor de 1 = Selva y 0 = Otros (o No Selva)
```{r}
ENAPRES$RegionSelva <- ifelse(ENAPRES$REGIONNATU == 3, 1, 0)
table(ENAPRES$RegionSelva)
```

(ii) Primero se construye un variable categórica que determine los siguientes grupos etarios:
```{r}
ENAPRES = ENAPRES |> 
  mutate(rango_edad=
           case_when(P208_A %in% c(1:11)~"11 a 24",
                     P208_A %in% c(12:24)~"12 a 24",
                     P208_A %in% c(25:64)~"25 a 64",
                     P208_A %in% c(65:99)~"65 a mas",
                     FALSE~"Ninguno"))

table(ENAPRES$P208_A)
```

## Pregunta 3.	Para la dicotómica, obtener la media y población. Para la continua, obtener la media (deben ser representativas). 
a.	Variable dicotómica = REGIONNATU (Selva ==1, Otros ==0): media y población
```{r}
svymean(~REGIONNATU , ENAPRES_svy)
svytotal(~REGIONNATU , ENAPRES_svy)
```

b.	Una continua = Grupo etario: P208_A: media (representativa)
```{r}
svymean(~P208_A , ENAPRES_svy)
```

# Parte III

## Pregunta 1. Un hacedor de políticas públicas que cuenta con conocimientos intermedios de estadística le pide que utilice la Encuesta Nacional Agropecuaria más reciente para obtener estadísticas distritales de acceso a asistencia técnica en agricultores de Ayacucho. Estos datos serán utilizados en el diseño de un programa público de apoyo a los productores. Explíquele al funcionario si esto es posible y por qué. En caso no sea posible, propóngale qué otra fuente de datos podría usarse y cuáles serían sus ventajas y desventajas. (Palabras: 300) 

De acuerdo a los módulos de la Encuesta Nacional Agropecuaria, se puede obtener información respecto al uso de la tierra, superficie sembrada y cosechada, superficie agricola con riego tecnificado, destinos de producción, porcentaje de productores que recibieron asistencia tecnica (ésta variable cuenta demasiados datos faltantes), etc, con los cuales pueden ser usados para un análisis estrictamente econometrico que permita evaluar el impacto (efectos positivos y negativos)de una política pública en Ayacucho, con los que se pueda evaluar de forma continua la evolución de dichos indicadores y
contribuya al diseño y orientación de programas.Por otro lado, de acuerdo a la Ficha Técnica del ENAGRO, no forman parte del estudio las unidades agropecuarias que son comunidades campesinas y nativas por lo que al enfocarnos en el departamento de Ayacucho nuestra muestra perdería representatividad.

Se podría proponer una base de datos mucho más representativa como el Censo Nacional Agropecuario del 2012, ya que nos proporciona un mejor conocimiento de la estructura
agraria del país a nivel de distrito, provincia y departamento, mientras que la del ENAGRO se enfoca a nivel de pequeñas, medianas y grandes unidades agropecuarias del país. Asimismo, del total de unidades agropecuarias censadas la CENAGRO posee mas del 98% como resultado final del censo completo.


## Pregunta 2. En el Ministerio de Desarrollo le han encargado a Ud. como muestrista principal diseñar una encuesta probabilística para medir la prevalencia de vulnerabilidad a la pobreza (variable dicotómica) en todas las regiones del Perú. Su supervisor, quien es un muy buen policymaker pero sin ninguna formación cuantitativa ni de muestreo, se enteró del libro de Dillman (2014) y de las tablas de cálculo de tamaño de muestra. Él está solicitándole que justifique sus decisiones metodológicas pues argumenta que “como máximo se necesitaría una muestra de tamaño n=1067 como se observa en la figura 3.5 de libro”. Ud. ha planteado que se levante un muestreo complejo (estratificado y biétapico) para lograr el objetivo. Explique en castellano sencillo y de forma intuitiva por qué necesitaría (o no) una muestra de mayor tamaño. Incluya en su respuesta el concepto de tamaño de muestra efectivo, correlación intracluster y efecto de diseño. Recuerde que su supervisor no maneja estos temas. (Palabras: 500)

Es verdad que solo necesitamos encuestar a 1067 personas para que nuestros resultados sean representativos de la población peruana con un nivel de confianza de 95% y con un margen de error de 3% para arriba y para abajo (lo aceptado en este sector). 

Pero esta recomendación es para un muestreo aleatorio simple, donde sacamos una muestra de toda la población del Perú. Esto significaría agarrar la lista de nombres de los más de 33 millones de peruanos y sacar al azar 1067 personas. Esto en la práctica conlleva a una serie de problemas. 

Primero, esa muestra es representativa para el Perú en su conjunto, pero no necesariamente para cada región. Para ello, necesitamos sacar 26 muestras representativas de cada región (llamada dominio en estadística). Por lo que es necesario volver a la tabla de Dillman y ver el tamaño de muestra considerando la población de cada región. 

Segundo, que podría tocarnos una muestra muy dispersa y nuestros recursos no alcanzan para enviar a nuestros encuestadores a tantos lugares distintos. 

Finalmente, aunque la teoría nos dice que si sacamos miles de muestras, en promedio deberíamos tener una nuestra muestra representativas de nuestra población, en la práctica puede que nos toque una muestra muy desbalanceada. Es decir que podrían tocar individuos solo de Lima, podrían tocar solo hombres o una muestra con gente mucho más propensa a caer en la pobreza.

Respecto al segundo punto, si queremos una muestra representativa con el mismo nivel de confianza y margen de error pero que sea factible tenemos que usar un muestreo por conglomerados. Por ejemplo, en vez de aleatorizar personas aleatorizamos distritos y dentro de cada distrito aleatorizamos personas, esto es un muestreo bietápico. Así nuestros encuestadores se desplazarán menos. Sin embargo, puede que los individuos en estos distritos sean similares en características que determinen la vulnerabilidad a la pobreza por lo que nuestra muestra es menos representativa que una extraída con muestreo aleatorio. Esta medida de similitud se llama correlación intracluster y entre más alta sea, menos información (medido con la varianza) nos da cada persona extra que encuestemos en nuestro conglomerado. 

Esta penalidad se mide con el efecto del diseño donde comparamos la varianza que da nuestra muestra bietápica comparada a la muestra simple. Para saber cuántas personas más, calculamos el tamaño de muestra efectivo, es decir el tamaño que nuestra muestra bietápica debe tener para que sea igual de informativa que nuestra muestra simple de 1067 personas. Para ello simplemente multiplicamos el efecto del diseño por 1067. 

Sobre el tercer punto, para conseguir muestras balanceadas, es mejor estratificar. Es decir, dividimos la muestra en bolos, por ejemplo, uno de hombres y mujeres, y extraemos aleatoriamente una muestra de cada grupo correspondiente a su proporción en la población. En este caso mitad hombres y mitad mujeres. Al ser un muestreo estratificado más representativo que el muestreo simple, su efecto de diseño es menor a 1, lo que conlleva a un tamaño de muestra efectivo menor. Esto nos permite encuestar a menos personas, aunque no compense la penalidad por dominio y por conglomerado.






