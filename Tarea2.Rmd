---
title: "Big Data & Analytics: Trabajo 2"
author: "S. Gutierrez, A. Mosqueira, A. Palacios, E. Quispe, "
date: "05/06/2022"
output:
  rmdformats::material:
  code_folding: show
  self_contained: true
  thumbnails: false
  lightbox: false
pkgdown:
  as_is: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Clear Global environment
rm(list=ls()) 
```

```{r message=FALSE, warning=FALSE}
library(readstata13)
library(survey)
library(tidyverse)
library(foreign)
library(haven)
library(dplyr)
library(rio)
library(tidyr)
library(sampling)
```

# Integrantes:
#### Andrés Palacios
#### Adriana Mosqueira
#### Elías Quispe
#### Sandra Gutierrez

# Parte I

### 1.	Descargue el Censo Nacional de Población Penitenciaria 2016 de la página del INEI (http://iinei.inei.gob.pe/microdatos/). Puede descargar solo la carátula o también más módulos de dicho censo.


```{r}
pob_penit= read_sav("01_PENALES_CARATULA.sav", encoding = "UTF-8", user_na = TRUE)
```


### 2.	Genere una variable dicotómica con el valor de 1 para quienes cometen “Delitos contra la seguridad pública”, 0 para los demás casos. Llamar a esta variable “pp_dcsp”

```{r}
# Generar la variable de internos que han cometido delitos con la seguridad pública
pob_penit <- pob_penit |> 
  mutate(pp_dcsp = if_else(DELITO_GENERICO=="DELITOS CONTRA LA SEGURIDAD PUBLICA",1,0))
```

### 3.	Establecer una semilla (“seed”) usando los dígitos del cumpleaños de alguno de los miembros del grupo.

```{r}
set.seed(19011990) # Clave para poder replicar
```

### 4.	Extraer una muestra estratificada y por conglomerados que contenga entre el 1% y 5% de la población (toda la base). Especificar qué variables se utilizan para los estratos y conglomerados y discutir por qué son adecuadas para dicho propósito. Discutir también si hay otras variables que podrían haberse utilizado para los estratos o conglomerados.

Muestra Aleatoria Estratificada

La variable usada para estratificar será el intervalo del número de internos por Establecimiento Penitenciario. Esto permite que cada elemento de un conglomerado pertenezca exclusivamente a un determinado estrato.También se puede utilizar otras variables en este caso sociodemográficas como sexo, edad, nivel educativo, etc.

```{r}
# Generamos una variable que contenga el total de la población por Establecimiento Penitenciario
internos_ep = pob_penit |> 
  count(EST_PENIT) |>
  rename(rango=n)
pob_penit <- merge(x = pob_penit , y = internos_ep , by = c("EST_PENIT"))
```


```{r}
# Estratificamos de acuerdo al rango de número de internos 
pob_penit <- pob_penit |> 
  mutate(rango = case_when(rango >=1 & rango <=1000 ~ "1 a 1000 internos",
                                rango >=1001 & rango <= 9000 ~ "1001 a 9000 internos" ,
                                rango > 9000 ~ "9000 internos a más"),
         .keep = "all")
```

```{r}
# Obtenemos el conteo de la poblaciones por estrato
pob_penit |> 
 count(rango) |> 
  rename(cantidad=n)
```


```{r}
# Estratificamos de acuerdo al rango de número de internos 
pob_penit <- pob_penit |> 
  mutate(rango3 = case_when(rango >=1 & rango <=1000 ~ "1 a 1000 internos",
                                rango >=1001 & rango <= 2000 ~ "1001 a 2000 internos", 
                                rango >=2001 & rango <= 3000 ~ "2001 a 3000 internos",
                                rango >=3001 & rango <= 4000 ~ "3001 a 4000 internos",
                                rango >=4001 & rango <= 9000 ~ "4001 a 9000 internos",
                                rango > 9000 ~ "9001 internos a más"),
         .keep = "all")
```

```{r}
table(pob_penit$EST_PENIT, by=pob_penit$rango3)
```


```{r}
pob_penit |> 
  count(rango3) |> 
  rename(cantidad=n)
```



```{r}
# Extraemos el Muestreo Aleatorio Estratificado por rango de poblacion de internos
set.seed(190190) # Clave para poder replicar
mae_pob_penit <- pob_penit |>
  group_by(rango) |> 
  slice_sample(prop = 0.05) 
# Obtenemos el conteo de la poblaciones por estrato
mae_pob_penit |> 
  count(rango) |> 
  rename(cantidad=n)
```

```{r}
# Ordenaremos de acuerdo al rango de internos
pob_penit= pob_penit[order(pob_penit$rango,pob_penit$EST_PENIT ), ]
dis1= list("stratified","cluster")
# La variable 'rango'(Rango de internos) tiene 3 estratos y se usa como variable de estratificación en la muestra de primera etapa 
# La variable 'EST_PENIT' (Establecimiento Penitenciario) tiene 65 categorías y se usa como variable de conglomerado en la muestra de segunda etapa.

#m =mstage(pob_penit,stage= dis1, varnames=list("rango","EST_PENIT"), size=list(c(614,2714,480), c(5,5,5)), method=list(" ","srswor"))
```


Muestra con conglomerados (una etapa)

```{r}
# Al muestrear conglomerados aleatoriamente.

# Primero, usamos la base por conglomerados (Estab. penitenciario) 
base_ep_clusters <- pob_penit %>%
  count(EST_PENIT)

# Segundo, obtenemos la muestra aleatoria de conglomerados (Estab. penitenciario)
set.seed(19011990)
mac1_pob_penit <- base_ep_clusters %>%
  slice_sample(prop = 0.05)

# Tercero, juntamos las bases para tener las observaciones de los clusters elegidos
mac1_f <- merge(x = pob_penit , y = mac1_pob_penit , by = c("EST_PENIT"))
```

Muestra con conglomerados (multietápica)

```{r}
# Muestreamos al interior de cada cluster. Tenemos 65 clusters y seleccionaremos 10 obs de cada uno. 
set.seed(19011990)
mac2_f <- mac1_f %>%
  group_by(EST_PENIT) %>%
  slice_sample(n = 10)
```

### 5.	Declarar el diseño muestral (completo) y obtener las siguientes estadísticas (deben ser representativas):

```{r}
#diseño_m = svydesign(id = ~EST_PENIT, strata = ~rango , fpc = ~fpc , data = muestra, nest = T)
```


#### a.	Porcentaje de personas que ha cometido “Delitos contra la seguridad pública”


#### b.	Total de personas que ha cometido “Delitos contra la seguridad pública”


# Parte II: ENARES

A cada grupo se le asignará una encuesta que pueda ser descargada de la página de microdatos del INEI. Dicha encuesta será utilizada para este ejercicio.

## 1.	Explicar el diseño muestral de la encuesta. Luego, declarar el diseño muestral (completo). Para esto se recomienda revisar la ficha técnica de la encuesta. Esta se encuentra disponible en la web de microdatos del INEI. 

La Encuesta Nacional de Programas Presupuestales (ENAPRES) tiene como objetivo, detallar información estadística para el seguimiento y evaluación de los Programas Presupuestales (PP) a nivel nacional. Esta encuesta incluye aquellas viviendas particulares y sus ocupantes, quienes residen en el área urbana y área rural del país; sin embargo, se excluyeron aquellas personas que viven en viviendas colectivas. En cuanto al marco muestral básico para la selección de la muestra, se utilizó la información estadística y cartográfica del Sistema de Focalización de Hogares (SISFOH), actualizada al 2012 y 2013 del directorio de viviendas de cada conglomerado seleccionado.

Por su parte, la unidad primaria de muestreo (UPM), diferencia entre el área urbano y rural. Para el primer caso, este se conformó por una o más manzanas consecutivas o adyacentes, además, un conglomerado urbano contiene en promedio 140 viviendas particulares. Para el segundo caso, se identificaron 2 tipos: el conglomerado rural conformado por una o más manzanas consecutivas o adyacentes que tiene 140 viviendas particulares en promedio y el Área de Empadronamiento Rural (AER) que contiene en promedio 100 viviendas particulares.

Además, para ambos caso se considero la vivienda particular comol la unidad secundaria de muestreo (USM). 

En cuanto al diseño muestral, es de tipo probabilística, estratificada, bietápica, independiente en cada departamento, de selección sistemática con probabilidad proporcional al tamaño en la primera etapa y sistemática simple en la segunda etapa. Además, se indica que el nivel de confianza de los resultados es del 95%.

```{r}
setwd("C:/Users/limon/OneDrive/2022/02. Diplomado/05. Big Data y Analytics para la GPP/PC2/761-Modulo1676")
```

```{r}
ENAPRES = read_csv("CAP_200_URBANO_RURAL_4.csv")
```

```{r}
table(ENAPRES$ESTRATO)
```


```{r}
# Declarar el diseño muestral
ENAPRES_svy = svydesign(id = ~1 , strata = ~ESTRATO, weights = ~FACTOR  , data = ENAPRES)
```

## 2.	Elegir y calcular dos variables: (i) una dicotómica = REGIONNATU (Selva ==1, Otros ==0), (ii) una continua = Grupo etario: P208_A. 

(i) Se construye una variable dicotómica, que tendrá el varlor de 1 = Selva y 0 = Otros (o No Selva)
```{r}
ENAPRES$RegionSelva <- ifelse(ENAPRES$REGIONNATU == 3, 1, 0)
table(ENAPRES$RegionSelva)
```

(ii) Primero se construye un variable categórica que determine los siguientes grupos etarios:
```{r}
ENAPRES = ENAPRES |> 
  mutate(rango_edad=
           case_when(P208_A %in% c(1:11)~"11 a 24",
                     P208_A %in% c(12:24)~"12 a 24",
                     P208_A %in% c(25:64)~"25 a 64",
                     P208_A %in% c(65:99)~"65 a mas",
                     FALSE~"Ninguno"))

table(ENAPRES$P208_A)
```

## 3.	Para la dicotómica, obtener la media y población. Para la continua, obtener la media (deben ser representativas). 
a.	Variable dicotómica = REGIONNATU (Selva ==1, Otros ==0): media y población
```{r}
svymean(~REGIONNATU , ENAPRES_svy)
svytotal(~REGIONNATU , ENAPRES_svy)
```

b.	Una continua = Grupo etario: P208_A: media (representativa)
```{r}
svymean(~P208_A , ENAPRES_svy)
```

# Parte III

Pregunta 1

# Un hacedor de políticas públicas que cuenta con conocimientos intermedios de estadística le pide que utilice la Encuesta Nacional Agropecuaria más reciente para obtener estadísticas distritales de acceso a asistencia técnica en agricultores de Ayacucho. Estos datos serán utilizados en el diseño de un programa público de apoyo a los productores. Explíquele al funcionario si esto es posible y por qué. En caso no sea posible, propóngale qué otra fuente de datos podría usarse y cuáles serían sus ventajas y desventajas. (Palabras: 300) 

De acuerdo a los módulos de la Encuesta Nacional Agropecuaria, se puede obtener información respecto al uso de la tierra, superficie sembrada y cosechada, superficie agricola con riego tecnificado, destinos de producción, porcentaje de productores que recibieron asistencia tecnica (ésta variable cuenta demasiados datos faltantes), etc, con los cuales pueden ser usados para un análisis estrictamente econometrico que permita evaluar el impacto (efectos positivos y negativos)de una política pública en Ayacucho, con los que se pueda evaluar de forma continua la evolución de dichos indicadores y
contribuya al diseño y orientación de programas.Por otro lado, de acuerdo a la Ficha Técnica del ENAGRO, no forman parte del estudio las unidades agropecuarias que son comunidades campesinas y nativas por lo que al enfocarnos en el departamento de Ayacucho nuestra muestra perdería representatividad.

Se podría proponer una base de datos mucho más representativa como el Censo Nacional Agropecuario del 2012, ya que nos proporciona un mejor conocimiento de la estructura
agraria del país a nivel de distrito, provincia y departamento, mientras que la del ENAGRO se enfoca a nivel de pequeñas, medianas y grandes unidades agropecuarias del país. Asimismo, del total de unidades agropecuarias censadas la CENAGRO posee mas del 98% como resultado final del censo completo.









